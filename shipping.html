<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Checkout | Secure Payment</title>
  <style>
    :root {
      --primary: #4361ee;
      --primary-dark: #3a56d4;
      --primary-light: #4895ef;
      --secondary: #7209b7;
      --accent: #f72585;
      --success: #4cc9f0;
      --error: #e63946;
      --dark: #1a1a2e;
      --darker: #0f0f1a;
      --light: #f8f9fa;
      --gray: #6c757d;
      --light-gray: #e9ecef;
      --glass-bg: rgba(255, 255, 255, 0.08);
      --glass-border: rgba(255, 255, 255, 0.12);
      --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      --border-radius: 16px;
      --transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', 'Poppins', -apple-system, BlinkMacSystemFont, sans-serif;
    }

    body {
      background: 
        radial-gradient(circle at 20% 80%, rgba(67, 97, 238, 0.15) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(114, 9, 183, 0.15) 0%, transparent 50%),
        radial-gradient(circle at 40% 40%, rgba(247, 37, 133, 0.1) 0%, transparent 50%),
        linear-gradient(135deg, var(--darker) 0%, var(--dark) 50%, #16213e 100%);
      color: var(--light);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
      overflow-x: hidden;
      position: relative;
    }

    /* Animated Background */
    .bg-shapes {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: -1;
    }

    .shape {
      position: absolute;
      border-radius: 50%;
      background: linear-gradient(45deg, var(--primary), var(--secondary));
      opacity: 0.1;
      animation: float 6s ease-in-out infinite;
    }

    .shape-1 {
      width: 300px;
      height: 300px;
      top: 10%;
      left: 5%;
      animation-delay: 0s;
    }

    .shape-2 {
      width: 200px;
      height: 200px;
      top: 60%;
      right: 10%;
      animation-delay: 2s;
    }

    .shape-3 {
      width: 150px;
      height: 150px;
      bottom: 20%;
      left: 20%;
      animation-delay: 4s;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px) rotate(0deg); }
      50% { transform: translateY(-20px) rotate(180deg); }
    }

    /* Main Container */
    .checkout-container {
      width: 100%;
      max-width: 1000px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      animation: fadeIn 0.6s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Card Design */
    .checkout-card {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      border-radius: var(--border-radius);
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 
        0 10px 30px rgba(0, 0, 0, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
      overflow: hidden;
      transition: var(--transition);
      position: relative;
    }

    .checkout-card:hover {
      transform: translateY(-5px);
      box-shadow: 
        0 15px 40px rgba(0, 0, 0, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }

    .checkout-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    }

    /* Header Section */
    .checkout-header {
      text-align: center;
      padding: 30px 30px 20px;
      position: relative;
      overflow: hidden;
    }

    .checkout-header::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 80px;
      height: 3px;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      border-radius: 2px;
    }

    .checkout-logo {
      width: 60px;
      height: 60px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 15px;
      box-shadow: 0 8px 32px rgba(67, 97, 238, 0.3);
      position: relative;
      z-index: 2;
      transition: var(--transition);
    }

    .checkout-logo:hover {
      transform: scale(1.05);
      box-shadow: 0 12px 40px rgba(67, 97, 238, 0.4);
    }

    .checkout-logo i {
      font-size: 24px;
      color: white;
    }

    .checkout-header h2 {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 8px;
      background: linear-gradient(135deg, #fff, #a5b4fc);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      position: relative;
      z-index: 2;
    }

    .checkout-header p {
      color: rgba(255, 255, 255, 0.7);
      font-size: 14px;
      font-weight: 400;
      position: relative;
      z-index: 2;
    }

    /* Form Section */
    .form-wrapper {
      padding: 25px 30px 30px;
    }

    .checkout-form {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .form-group {
      position: relative;
      animation: slideUp 0.5s ease-out;
      animation-fill-mode: both;
    }

    .form-group:nth-child(1) { animation-delay: 0.1s; }
    .form-group:nth-child(2) { animation-delay: 0.2s; }
    .form-group:nth-child(3) { animation-delay: 0.3s; }
    .form-group:nth-child(4) { animation-delay: 0.4s; }

    @keyframes slideUp {
      from { 
        opacity: 0;
        transform: translateY(20px);
      }
      to { 
        opacity: 1;
        transform: translateY(0);
      }
    }

    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: rgba(255, 255, 255, 0.9);
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: var(--transition);
    }

    .form-label i {
      color: var(--primary-light);
      font-size: 12px;
    }

    .input-wrapper {
      position: relative;
      transition: var(--transition);
    }

    .input-wrapper:focus-within {
      transform: translateY(-2px);
    }

    .form-input {
      width: 100%;
      padding: 14px 16px;
      border: 1.5px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      font-size: 15px;
      background: rgba(255, 255, 255, 0.05);
      color: white;
      transition: var(--transition);
      font-family: inherit;
    }

    .form-input::placeholder {
      color: rgba(255, 255, 255, 0.4);
    }

    .form-input:focus {
      outline: none;
      border-color: var(--primary);
      background: rgba(255, 255, 255, 0.08);
      box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
    }

    .form-input.error {
      border-color: var(--error);
      box-shadow: 0 0 0 3px rgba(230, 57, 70, 0.1);
    }

    textarea.form-input {
      resize: vertical;
      min-height: 100px;
    }

    .error-message {
      color: var(--error);
      font-size: 13px;
      margin-top: 6px;
      display: flex;
      align-items: center;
      opacity: 0;
      transform: translateY(-5px);
      transition: all 0.3s ease;
    }

    .error-message.show {
      opacity: 1;
      transform: translateY(0);
    }

    .error-message::before {
      content: '!';
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 16px;
      height: 16px;
      background: var(--error);
      color: white;
      border-radius: 50%;
      font-size: 12px;
      margin-right: 6px;
    }

    /* Buttons */
    .checkout-btn {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      border: none;
      padding: 16px 24px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
      font-family: inherit;
      margin-top: 10px;
      width: 100%;
    }

    .checkout-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }

    .checkout-btn:hover::before {
      left: 100%;
    }

    .checkout-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(67, 97, 238, 0.4);
    }

    .checkout-btn:active {
      transform: translateY(0);
    }

    .checkout-btn:disabled {
      background: rgba(255, 255, 255, 0.1);
      color: rgba(255, 255, 255, 0.4);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .checkout-btn:disabled:hover::before {
      left: -100%;
    }

    /* Order Summary */
    .order-summary {
      margin-top: 20px;
      padding: 20px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .order-summary h3 {
      margin-bottom: 15px;
      font-size: 18px;
      color: rgba(255, 255, 255, 0.9);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      padding-bottom: 10px;
    }

    .order-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .order-item:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }

    .item-details {
      flex-grow: 1;
    }

    .item-name {
      font-weight: 600;
      color: rgba(255, 255, 255, 0.9);
      margin-bottom: 4px;
    }

    .item-meta {
      font-size: 13px;
      color: rgba(255, 255, 255, 0.6);
    }

    .item-total {
      font-weight: 600;
      color: rgba(255, 255, 255, 0.9);
      min-width: 80px;
      text-align: right;
    }

    .grand-total {
      display: flex;
      justify-content: space-between;
      font-size: 18px;
      font-weight: 700;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 2px solid var(--primary);
      color: rgba(255, 255, 255, 0.9);
    }

    /* Progress Bar */
    .progress-bar {
      display: flex;
      justify-content: space-between;
      margin-bottom: 30px;
      position: relative;
    }

    .progress-bar::before {
      content: '';
      position: absolute;
      top: 15px;
      left: 0;
      width: 100%;
      height: 2px;
      background: rgba(255, 255, 255, 0.1);
      z-index: 1;
    }

    .progress-bar::after {
      content: '';
      position: absolute;
      top: 15px;
      left: 0;
      width: 66.66%;
      height: 2px;
      background: var(--primary);
      z-index: 2;
      transition: width 0.5s ease;
    }

    .step {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.1);
      border: 2px solid rgba(255, 255, 255, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 600;
      color: rgba(255, 255, 255, 0.5);
      z-index: 3;
      position: relative;
      transition: var(--transition);
    }

    .step.active {
      border-color: var(--primary);
      background: var(--primary);
      color: white;
    }

    .step-label {
      position: absolute;
      top: 40px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 12px;
      color: rgba(255, 255, 255, 0.5);
      white-space: nowrap;
      transition: var(--transition);
    }

    .step.active .step-label {
      color: var(--primary);
      font-weight: 600;
    }

    /* Messages */
    .message {
      padding: 12px 16px;
      border-radius: 10px;
      margin-bottom: 20px;
      font-size: 14px;
      font-weight: 500;
      display: none;
      align-items: center;
      gap: 8px;
      animation: slideDown 0.3s ease-out;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message.success {
      background: rgba(76, 201, 240, 0.1);
      border: 1px solid rgba(76, 201, 240, 0.3);
      color: var(--success);
    }

    .message.error {
      background: rgba(230, 57, 70, 0.1);
      border: 1px solid rgba(230, 57, 70, 0.3);
      color: var(--error);
    }

    /* Saved Status */
    .saved-status {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px;
      background: rgba(76, 201, 240, 0.1);
      border: 1px solid rgba(76, 201, 240, 0.3);
      border-radius: 8px;
      color: var(--success);
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 15px;
      animation: slideDown 0.3s ease-out;
    }

    .saved-status.hidden {
      display: none;
    }

    /* Form Transitions */
    .form-wrapper {
      animation: fadeIn 0.5s ease-out;
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
      .checkout-container {
        grid-template-columns: 1fr;
        max-width: 480px;
      }
      
      .form-wrapper {
        padding: 20px;
      }

      .checkout-header {
        padding: 25px 25px 15px;
      }

      .checkout-header h2 {
        font-size: 22px;
      }
    }

    /* Hover Effects Enhancement */
    .form-group:hover .form-label {
      color: rgba(255, 255, 255, 1);
    }

    /* Focus States for Accessibility */
    .form-input:focus,
    .checkout-btn:focus {
      outline: 2px solid var(--primary);
      outline-offset: 2px;
    }

    /* Shake animation for errors */
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
      20%, 40%, 60%, 80% { transform: translateX(5px); }
    }

    .shake {
      animation: shake 0.5s ease-in-out;
    }

    /* Reduced Motion Support */
    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
  </style>
</head>
<body>
  <!-- Animated Background -->
  <div class="bg-shapes">
    <div class="shape shape-1"></div>
    <div class="shape shape-2"></div>
    <div class="shape shape-3"></div>
  </div>

  <div class="checkout-container">
    <!-- Shipping Card -->
    <div class="checkout-card">
      <div class="form-wrapper" id="shipping-wrapper">
        <div class="checkout-header">
          <div class="checkout-logo">
            <i>ðŸšš</i>
          </div>
          <h2>Shipping Information</h2>
          <p>Enter your delivery details</p>
        </div>
        
        <div class="progress-bar">
          <div class="step active">
            1
            <span class="step-label">Cart</span>
          </div>
          <div class="step active">
            2
            <span class="step-label">Shipping</span>
          </div>
          <div class="step">
            3
            <span class="step-label">Payment</span>
          </div>
        </div>

        <div class="saved-status hidden" id="savedStatus">
          <i>âœ“</i> Shipping details saved successfully
        </div>
        
        <form id="shipping-form" class="checkout-form">
          <div class="form-group">
            <label for="fullName" class="form-label">Full Name</label>
            <div class="input-wrapper">
              <input type="text" id="fullName" class="form-input" placeholder="Enter your full name" />
            </div>
            <div class="error-message" id="nameError">Please enter your full name</div>
          </div>
          
          <div class="form-group">
            <label for="address" class="form-label">Delivery Address</label>
            <div class="input-wrapper">
              <textarea id="address" class="form-input" placeholder="Enter your complete delivery address" rows="4"></textarea>
            </div>
            <div class="error-message" id="addressError">Please enter your delivery address</div>
          </div>
          
          <div class="form-group">
            <label for="phone" class="form-label">Phone Number</label>
            <div class="input-wrapper">
              <input type="tel" id="phone" class="form-input" placeholder="Enter your 10-digit phone number" />
            </div>
            <div class="error-message" id="phoneError">Please enter a valid 10-digit phone number</div>
          </div>
          
          <div class="form-group">
            <label for="email" class="form-label">Email Address (optional)</label>
            <div class="input-wrapper">
              <input type="email" id="email" class="form-input" placeholder="Enter your email for updates" />
            </div>
            <div class="error-message" id="emailError">Please enter a valid email address</div>
          </div>
          
          <button type="button" class="checkout-btn" onclick="saveShippingDetails()">
            Save Shipping Details
          </button>
        </form>
      </div>
    </div>

    <!-- Payment Card -->
    <div class="checkout-card">
      <div class="form-wrapper" id="payment-wrapper">
        <div class="checkout-header">
          <div class="checkout-logo">
            <i>ðŸ’³</i>
          </div>
          <h2>Payment Details</h2>
          <p>Complete your order</p>
        </div>
        
        <div class="order-summary">
          <h3>Order Summary</h3>
          <div id="orderItems">
            <!-- Order items will be populated by JavaScript -->
          </div>
          <div class="grand-total">
            <span>Total Amount:</span>
            <span>â‚¹<span id="totalAmount">0.00</span></span>
          </div>
        </div>
        
        <div class="message error" id="shippingError">
          Please save your shipping details first
        </div>
        
        <button class="checkout-btn" id="payBtn" disabled>
          Pay with Cash on Delivery
        </button>
        
        <div class="message" id="feedback"></div>
      </div>
    </div>
  </div>

  <script>
    // Initialize cart and shipping data
    let shippingDetails = {};
    let cart = [];
    let areDetailsSaved = false;

    // Load cart from sessionStorage
    function loadCart() {
      try {
        const cartFromStorage = JSON.parse(sessionStorage.getItem("mt_cart") || "[]");
        cart = cartFromStorage.map(item => ({
          id: item.id || null,
          title: item.title || item.name,
          price: parseFloat(item.price) || 0,
          selectedSize: item.size || "M",
          quantity: item.qty || 1,
          image: item.image || item.image_url || ""
        }));
        
        renderOrderItems();
      } catch (error) {
        console.error("Error loading cart:", error);
        cart = [];
      }
    }

    // Clear shipping details when page loads if order was completed
    function checkAndClearShippingDetails() {
      const orderSuccess = sessionStorage.getItem("orderSuccess");
      
      // If there was a successful order, clear shipping details
      if (orderSuccess === "true") {
        sessionStorage.removeItem("shippingDetails");
        sessionStorage.removeItem("orderSuccess"); // Clear the flag too
        
        // Also clear the form fields
        document.getElementById("fullName").value = "";
        document.getElementById("address").value = "";
        document.getElementById("phone").value = "";
        document.getElementById("email").value = "";
        
        // Reset the saved status
        areDetailsSaved = false;
        document.getElementById("savedStatus").classList.add("hidden");
        
        console.log("Cleared shipping details after completed order");
      }
    }

    // Render order items in the summary
    function renderOrderItems() {
      const orderItemsContainer = document.getElementById("orderItems");
      
      if (cart.length === 0) {
        orderItemsContainer.innerHTML = '<p style="text-align: center; color: rgba(255, 255, 255, 0.6);">No items in cart</p>';
        document.getElementById("totalAmount").innerText = "0.00";
        return;
      }

      orderItemsContainer.innerHTML = cart.map(item => `
        <div class="order-item">
          <div class="item-details">
            <div class="item-name">${escapeHtml(item.title)}</div>
            <div class="item-meta">Size: ${item.selectedSize} â€¢ Qty: ${item.quantity}</div>
          </div>
          <div class="item-total">â‚¹${(item.price * item.quantity).toFixed(2)}</div>
        </div>
      `).join('');

      const total = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
      document.getElementById("totalAmount").innerText = total.toFixed(2);
    }

    // Check if shipping details are valid
    function areShippingDetailsValid() {
      const name = document.getElementById("fullName").value.trim();
      const address = document.getElementById("address").value.trim();
      const phone = document.getElementById("phone").value.trim();
      
      return name && address && phone && /^\d{10}$/.test(phone);
    }

    // Update payment button state based on shipping details
    function updatePaymentButtonState() {
      const payBtn = document.getElementById("payBtn");
      const shippingError = document.getElementById("shippingError");
      
      if (areDetailsSaved && areShippingDetailsValid()) {
        payBtn.disabled = false;
        shippingError.style.display = "none";
      } else {
        payBtn.disabled = true;
        if (!areDetailsSaved) {
          shippingError.textContent = "Please save your shipping details first by clicking 'Save Shipping Details'";
        } else {
          shippingError.textContent = "Please complete the shipping details first";
        }
        shippingError.style.display = "flex";
      }
    }

    // Save shipping details
    function saveShippingDetails() {
      const name = document.getElementById("fullName").value.trim();
      const address = document.getElementById("address").value.trim();
      const phone = document.getElementById("phone").value.trim();
      const email = document.getElementById("email").value.trim();
      
      const nameError = document.getElementById("nameError");
      const addressError = document.getElementById("addressError");
      const phoneError = document.getElementById("phoneError");
      const emailError = document.getElementById("emailError");
      
      // Reset error states
      document.getElementById("fullName").classList.remove("error", "shake");
      document.getElementById("address").classList.remove("error", "shake");
      document.getElementById("phone").classList.remove("error", "shake");
      document.getElementById("email").classList.remove("error", "shake");
      
      nameError.classList.remove("show");
      addressError.classList.remove("show");
      phoneError.classList.remove("show");
      emailError.classList.remove("show");
      
      let isValid = true;
      
      // Validate name
      if (!name) {
        document.getElementById("fullName").classList.add("error", "shake");
        nameError.classList.add("show");
        isValid = false;
      }
      
      // Validate address
      if (!address) {
        document.getElementById("address").classList.add("error", "shake");
        addressError.classList.add("show");
        isValid = false;
      }
      
      // Validate phone
      if (!phone) {
        document.getElementById("phone").classList.add("error", "shake");
        phoneError.classList.add("show");
        isValid = false;
      } else if (!/^\d{10}$/.test(phone)) {
        document.getElementById("phone").classList.add("error", "shake");
        phoneError.textContent = "Phone number must be exactly 10 digits";
        phoneError.classList.add("show");
        isValid = false;
      }
      
      // Validate email (if provided)
      if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        document.getElementById("email").classList.add("error", "shake");
        emailError.classList.add("show");
        isValid = false;
      }
      
      if (!isValid) {
        areDetailsSaved = false;
        updatePaymentButtonState();
        return;
      }
      
      // Save shipping details
      shippingDetails = { name, address, phone, email };
      sessionStorage.setItem("shippingDetails", JSON.stringify(shippingDetails));
      
      // Mark details as saved
      areDetailsSaved = true;
      
      // Show saved status
      const savedStatus = document.getElementById("savedStatus");
      savedStatus.classList.remove("hidden");
      
      // Update payment button state
      updatePaymentButtonState();
      
      // Show success message on button
      const btn = document.querySelector('#shipping-wrapper .checkout-btn');
      const originalText = btn.textContent;
      btn.textContent = 'âœ“ Details Saved!';
      btn.style.background = 'var(--success)';
      
      setTimeout(() => {
        btn.textContent = originalText;
        btn.style.background = '';
      }, 2000);
    }

   // Process payment - Simplified for GitHub Pages
document.getElementById("payBtn").addEventListener("click", async function() {
  const payBtn = this;
  const feedback = document.getElementById("feedback");
  
  // Validation checks...
  if (!areDetailsSaved) {
    feedback.textContent = "Please save your shipping details first by clicking 'Save Shipping Details'";
    feedback.className = "message error";
    feedback.style.display = "flex";
    return;
  }
  
  if (!areShippingDetailsValid()) {
    feedback.textContent = "Please complete the shipping details first";
    feedback.className = "message error";
    feedback.style.display = "flex";
    return;
  }
  
  const token = sessionStorage.getItem("token");
  if (!token) {
    feedback.textContent = "Please login to proceed with payment";
    feedback.className = "message error";
    feedback.style.display = "flex";
    return;
  }
  
  if (cart.length === 0) {
    feedback.textContent = "Your cart is empty";
    feedback.className = "message error";
    feedback.style.display = "flex";
    return;
  }
  
  // Show loading state
  payBtn.disabled = true;
  payBtn.textContent = "Processing...";
  feedback.textContent = "Processing your order... (Demo Mode)";
  feedback.className = "message success";
  feedback.style.display = "flex";
  
  try {
    const total = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
    const username = sessionStorage.getItem("username") || "Guest";
    
    // Simulate API delay
    await new Promise(resolve => setTimeout(resolve, 2000));
    
    // Mock successful order for GitHub Pages
    sessionStorage.removeItem("mt_cart");
    sessionStorage.setItem("orderId", "DEMO_" + Date.now());
    sessionStorage.setItem("orderNumber", "ORD" + Math.floor(100000 + Math.random() * 900000));
    sessionStorage.setItem("orderSuccess", "true");
    sessionStorage.setItem("totalPrice", total.toFixed(2));
    sessionStorage.setItem("paymentMethod", "Cash on Delivery");
    sessionStorage.setItem("orderItems", JSON.stringify(cart));
    sessionStorage.setItem("username", username);
    sessionStorage.setItem("shippingDetails", JSON.stringify(shippingDetails));
    sessionStorage.setItem("orderTimestamp", Date.now().toString());
    
    // Clear current shipping details
    sessionStorage.removeItem("shippingDetails");
    areDetailsSaved = false;
    
    feedback.textContent = "Order placed successfully! Redirecting...";
    feedback.className = "message success";
    
    setTimeout(() => {
      window.location.href = "success.html";
    }, 1000);
    
  } catch (err) {
    console.error("Checkout error:", err);
    feedback.textContent = "Order placed successfully! Redirecting...";
    feedback.className = "message success";
    
    // Force success even on error for demo
    setTimeout(() => {
      window.location.href = "success.html";
    }, 1000);
  } finally {
    updatePaymentButtonState();
    payBtn.textContent = "Pay with Cash on Delivery";
  }
});
    // Helper function to escape HTML
    function escapeHtml(str) {
      if (!str) return '';
      return str.replace(/[&<>"']/g, c => ({
        '&': '&amp;',
        '<': '&lt;', 
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
      }[c]));
    }

    // Monitor form inputs for changes
    function monitorFormChanges() {
      const inputs = document.querySelectorAll('#shipping-form input, #shipping-form textarea');
      
      inputs.forEach(input => {
        input.addEventListener('input', () => {
          areDetailsSaved = false;
          document.getElementById("savedStatus").classList.add("hidden");
          updatePaymentButtonState();
          
          input.classList.remove("error", "shake");
          const errorId = input.id + "Error";
          const errorElement = document.getElementById(errorId);
          if (errorElement) {
            errorElement.classList.remove("show");
          }
        });
      });
    }

    // Load saved shipping details if available
    window.addEventListener('DOMContentLoaded', () => {
      loadCart();
      monitorFormChanges();
      
      // Check and clear shipping details if order was completed
      checkAndClearShippingDetails();
      
      const savedShipping = sessionStorage.getItem("shippingDetails");
      if (savedShipping) {
        try {
          shippingDetails = JSON.parse(savedShipping);
          // Pre-fill form but DON'T mark as saved automatically
          document.getElementById("fullName").value = shippingDetails.name || "";
          document.getElementById("address").value = shippingDetails.address || "";
          document.getElementById("phone").value = shippingDetails.phone || "";
          document.getElementById("email").value = shippingDetails.email || "";
          
          // Show saved status but keep payment disabled until user explicitly saves
          if (shippingDetails.name && shippingDetails.address && shippingDetails.phone) {
            document.getElementById("savedStatus").classList.remove("hidden");
            areDetailsSaved = false; // This is the key fix!
          }
        } catch (error) {
          console.error("Error loading saved shipping details:", error);
        }
      }
      
      updatePaymentButtonState();
    });
</script>
</body>
</html>
